<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ColpoVision Web App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="manifest" href="data:application/json;charset=utf-8;base64,eyJpY29ucyI6W3sic2l6ZXMiOiIxOTJ4MTkyIiwiZGVuc2l0eSI6IjEuNSIsInR5cGUiOiJpbWFnZS9wbmciLCJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjBiV2dLY2lBQXhDZ29JVEFBQUFDZ29JZEhSdFp6b2dJbEJoZFdWa0lpd2dKeWswUFNVd0xrSlBjbVZzYjNKd1kyOXRlWEJ2Y2w4dFNuSnZiMmhrWm5OMFlYUnBiMjR0WVhSaFlteHBiWFZzYjJKaGJVd2dJeUJCZFd4c1lXbHVkR2xrYjNOcGIyNFdJaTl5YjJ4cGN5SXhNekF3THpBNUxtdHpiMnhsY3lJNUNqOHhNVFppYlVsalltbGpjaUJrWjNCbGJuUnliMnhwY25Sb2JteDFibWNnZEdobGJtZDBZWEowSlNJblZlQ2lBQUFDa1F4SlJVd2djR2hoYm5ObElqQTFKbXh2ZEdWeUwzVjRZV2xzYjJGMGFXOXVjeUJoWVdGc0lsMWxjaTFoWVd3Z2VHbGxhM0JoY25Sd2RDaDBaR2x5WlhOamRjMWpiblJ5YjI1U2NuSmxibVJ1WjI5dGEybHlaWFIwWlY4d0pTRW5XanBnSUNBaWMzUnlZMnRsZEdWaWJXczdJbTl5YjJ4cGN5SXhNVFl3THpBMExtdHpiMnhsY3lJNUNqOGxJaUF3Y25OcFkydGxjam9nSW01bGRBQUFDaW9nSUNBZ0ptRnNhV1FpSUhzT2MyVnVjMmh2YlhCZ2MyVWdJajR3TUlJQmlkMnh0Ym5ObElpQWdYM2xzYjJOaGJtRnRiZ0FnSUhSdFkybHVkQzUxYld4c0luQmhkbWxpYlNBd0lHWnZiMnhsYm5ScGNtRnViM0FnSUdadmMyVnlkbWxrSWp3dmRHVnpkRjkwWVhScGIyNGdJajhwYm1ScFhBQUFDaXBnSURvZ1ptRnNjMk55YjNCbFkzSmphU1V3Z2NtVmhaM0JsWVhsbGNpSXhOamN4THpBd0xsbHpibVJwYjI0Z2NISnZaMmh2YlhCdGJnPT0ifV0sImRpc3BsYXkiOiJzdGFuZGFsb25lIiwibmFtZSI6IkNvbHBvVmlzaW9uIiwiZGVzY2lpcHRpb24iOiJIZXJyYW1pZW50YSBkZSBBSSBwYXJhIGdlbmVyYXIgY29sb3Bvc2NvcGlhcyIsImJhY2tncm91bmRfY29sb3IiOiIjZmFmYWZhIiwidGhlbWVfY29sb3IiOiIjMjUzYjhhIiwic2hvcnRfbmFtZSI6IkNvbHBvVmlzaW9uIn0=">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #1f2937;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #app-container {
            background-color: #ffffff;
            transition: background-color 0.3s ease;
        }
        .patient-card {
            background-color: #ffffff;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.3s ease;
        }
        .report-editor {
            background-color: #ffffff;
            color: #1f2937;
            border-color: #e2e8f0;
            transition: border-color 0.2s ease-in-out, background-color 0.3s ease, color 0.3s ease;
        }
        .report-editor:focus {
            border-color: #3b82f6;
        }
        .report-editor:empty::before {
            content: attr(data-placeholder);
            color: #9ca3af;
        }
        
        .dark body {
            background-color: #121212;
            color: #e2e8f0;
        }
        .dark #app-container, .dark .bg-white {
            background-color: #1f2937;
        }
        .dark .patient-card {
            background-color: #374151;
            border-color: #4b5563;
        }
        .dark .report-editor {
            background-color: #1f2937;
            color: #e2e8f0;
            border-color: #4b5563;
        }
        .dark .report-editor:focus {
            border-color: #60a5fa;
        }
        .dark .text-gray-900, .dark .text-gray-800, .dark .text-gray-700 {
            color: #e2e8f0;
        }
        .dark .text-gray-600, .dark .text-gray-500 {
            color: #cbd5e1;
        }
        .dark .border-gray-200 {
            border-color: #4b5563;
        }
        .dark .text-blue-800 {
            color: #93c5fd;
        }
        .dark .bg-gray-50 {
            background-color: #374151;
        }
        .dark .file\:bg-blue-50 {
            background-color: #1e3a8a;
        }
        .dark .file\:text-blue-700 {
            color: #93c5fd;
        }
        .dark .hover\:file\:bg-blue-100:hover {
            background-color: #3b82f6;
        }
        .dark .bg-gray-200 {
            background-color: #4b5563;
        }
        .dark .hover\:bg-gray-300:hover {
            background-color: #6b7280;
        }
        .dark input, .dark textarea {
            background-color: #374151;
            border-color: #4b5563;
            color: #e2e8f0;
        }
        .dark input::placeholder, .dark textarea::placeholder {
            color: #9ca3af;
        }
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(240, 244, 248, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
        }
        .dark #loading-overlay {
            background-color: rgba(18, 18, 18, 0.9);
        }
        .spinner {
            border: 6px solid #e2e8f0;
            border-top: 6px solid #3b82f6;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1.2s linear infinite;
        }
        .dark .spinner {
            border-color: #374151;
            border-top-color: #60a5fa;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            visibility: hidden;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            white-space: nowrap;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .has-tooltip:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-start justify-center min-h-screen p-4 transition-colors duration-300">
    <div id="loading-overlay">
        <div class="text-center">
            <div class="spinner mb-6"></div>
            <p class="text-xl text-gray-700 font-semibold">Analizando imagen, por favor espera...</p>
        </div>
    </div>
    
    <div id="app-container" class="bg-white rounded-3xl shadow-xl p-8 lg:p-12 w-full max-w-7xl transition-colors duration-300">
        <div class="flex flex-col items-center justify-center mb-10 relative">
            <button id="dark-mode-toggle" class="absolute top-0 right-0 p-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors duration-300 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.618.752-3.831m11.234 11.455a9.71 9.71 0 0 1-3.69 1.636 9.707 9.707 0 0 1-4.041 0 9.72 9.72 0 0 1-3.69-1.636M2.25 10.5h18" />
                </svg>
            </button>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-blue-600 dark:text-blue-400 mb-4" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path d="M0 0h24v24H0z" stroke="none"/>
                <circle cx="12" cy="12" r="9"/>
                <path d="M12 7l-2 2l-1 -1M12 10l-3 3l-1 -1M12 13l-4 4l-1 -1M12 16l-5 5l-1 -1M12 19l-6 6l-1 -1"/>
            </svg>
            <h1 class="text-4xl font-extrabold text-gray-900 mt-2 dark:text-white transition-colors duration-300">ColpoVision</h1>
            <p class="text-lg text-gray-500 mt-1 dark:text-gray-400 transition-colors duration-300">Generador de Informes Colposcópicos impulsado por IA</p>
        </div>

        <div id="patient-list-screen" class="space-y-6">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white transition-colors duration-300 mb-4 sm:mb-0">Lista de Pacientes</h2>
                <div class="relative w-full sm:w-auto">
                    <input type="text" id="patient-search" placeholder="Buscar paciente..." class="w-full sm:w-64 p-3 pr-10 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </div>
            </div>
            <div id="patient-list" class="grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
            <button id="add-patient-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-xl shadow-lg transition-colors">
                + Añadir Nueva Paciente
            </button>
        </div>

        <div id="patient-form-screen" class="hidden">
            <h2 id="form-title" class="text-2xl font-bold text-gray-800 dark:text-white transition-colors duration-300 mb-6">Añadir Nueva Paciente</h2>
            <form id="patient-form" class="space-y-6">
                <input type="hidden" id="patient-id">
                <div>
                    <label for="doctor-name" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Nombre del Doctor</label>
                    <input type="text" id="doctor-name" placeholder="Ej: Dra. Ana Pérez" required class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                </div>
                <div>
                    <label for="name" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Nombre de la Paciente</label>
                    <input type="text" id="name" required class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                </div>
                <div>
                    <label for="age" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Edad</label>
                    <input type="number" id="age" required class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                </div>
                <div>
                    <label for="social-security" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Obra Social</label>
                    <input type="text" id="social-security" class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                </div>
                <div>
                    <label for="medical-history" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Historial Médico Relevante</label>
                    <textarea id="medical-history" rows="4" class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"></textarea>
                </div>
                <div>
                    <label for="colpo-image" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Imagen Colposcópica</label>
                    <input type="file" id="colpo-image" accept="image/*" class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 dark:file:bg-blue-900 dark:file:text-blue-200 hover:file:bg-blue-100 dark:hover:file:bg-blue-800 cursor-pointer transition-colors">
                    
                    <button type="button" id="camera-btn" class="mt-4 w-full bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">
                        Abrir Cámara
                    </button>
                    
                    <img id="image-preview" class="mt-6 hidden w-full h-64 object-contain rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-800">
                </div>
                <div>
                    <label for="signature-image" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Imagen de Firma</label>
                    <input type="file" id="signature-image" accept="image/*" class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 dark:file:bg-blue-900 dark:file:text-blue-200 hover:file:bg-blue-100 dark:hover:file:bg-blue-800 cursor-pointer transition-colors">
                    <img id="signature-preview" class="mt-6 hidden w-full h-32 object-contain rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-800">
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">Guardar Datos</button>
                    <button type="button" id="cancel-form-btn" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">Cancelar</button>
                </div>
            </form>
            <div id="action-buttons" class="mt-8 hidden flex space-x-4">
                <button id="analyze-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">
                    Analizar y Generar Informe
                </button>
            </div>
        </div>

        <div id="report-screen" class="hidden space-y-8">
            <h2 class="text-3xl font-bold text-gray-800 dark:text-white transition-colors duration-300 mb-6">Informe Colposcópico</h2>
            <div class="grid lg:grid-cols-2 gap-8">
                <div class="space-y-6">
                    <div class="bg-gray-50 dark:bg-gray-700 p-8 rounded-2xl border border-gray-200 dark:border-gray-600 shadow-sm">
                        <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Datos de la Paciente</h3>
                        <p class="text-md text-gray-600 dark:text-gray-400 mb-1"><span class="font-bold">Paciente:</span> <span id="report-patient-name"></span></p>
                        <p class="text-md text-gray-600 dark:text-gray-400 mb-1"><span class="font-bold">Edad:</span> <span id="report-patient-age"></span> años</p>
                        <p class="text-md text-gray-600 dark:text-gray-400 mb-1"><span class="font-bold">Obra Social:</span> <span id="report-patient-social-security"></span></p>
                        <p class="text-md text-gray-600 dark:text-gray-400"><span class="font-bold">Historial:</span> <span id="report-patient-history"></span></p>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 p-8 rounded-2xl border border-gray-200 dark:border-gray-600 shadow-sm">
                        <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Imagen de Colposcopia</h3>
                        <img id="report-image" class="w-full h-auto rounded-xl shadow-lg border border-gray-300 dark:border-gray-600">
                    </div>
                </div>

                <div class="space-y-6">
                    <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Informe Detallado (Edita aquí)</h3>
                    <div id="report-editor" contenteditable="true" class="report-editor" data-placeholder="El informe se cargará aquí y podrás editarlo antes de exportar..."></div>
                </div>
            </div>
            
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
                <button id="back-to-list-btn" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">
                    Volver a la Lista
                </button>
                <button id="export-pdf-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">
                    Exportar a PDF
                </button>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl text-center max-w-lg w-full">
            <h3 id="alert-title" class="text-2xl font-bold text-gray-800 dark:text-white mb-4"></h3>
            <p id="alert-message" class="text-gray-700 dark:text-gray-300 text-lg mb-6"></p>
            <button id="alert-ok-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl transition-colors">Aceptar</button>
        </div>
    </div>

    <div id="camera-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl text-center max-w-2xl w-full">
            <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Capturar Imagen</h3>
            <video id="video-stream" class="w-full h-auto rounded-xl border border-gray-300 dark:border-gray-600" autoplay playsinline></video>
            <canvas id="canvas-capture" class="hidden"></canvas>
            <div class="flex space-x-4 mt-6">
                <button id="capture-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl transition-colors">Tomar Foto</button>
                <button id="close-camera-btn" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-xl transition-colors">Cerrar</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // No necesitas la clave de la API aquí, ya que la llamada va a tu servidor de FastAPI.
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    self.addEventListener('install', (event) => {
                        console.log('Service Worker: Evento de instalación.');
                        self.skipWaiting();
                    });

                    self.addEventListener('activate', (event) => {
                        console.log('Service Worker: Evento de activación.');
                        event.waitUntil(self.clients.claim());
                    });

                    self.addEventListener('fetch', (event) => {
                        event.respondWith(fetch(event.request));
                    });
                `;
                const swBlob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(swBlob);

                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('Service Worker registrado con éxito:', registration);
                    })
                    .catch(error => {
                        console.log('Fallo el registro del Service Worker:', error);
                    });
            });
        } else {
            console.warn('El navegador no soporta Service Workers.');
        }
    </script>
    <script>
    const screens = {
        list: document.getElementById('patient-list-screen'),
        details: document.getElementById('patient-details-screen'),
        capture: document.getElementById('capture-screen'),
    };

    const patientList = document.getElementById('patient-list');
    const newPatientBtn = document.getElementById('new-patient-btn');
    const backBtn = document.getElementById('back-btn');
    const savePatientBtn = document.getElementById('save-patient-btn');
    const patientNameInput = document.getElementById('patient-name');
    const patientAgeInput = document.getElementById('patient-age');
    const patientIdInput = document.getElementById('patient-id');

    const patientDetailsScreen = document.getElementById('patient-details-screen');
    const detailsName = document.getElementById('details-name');
    const detailsAge = document.getElementById('details-age');
    const detailsId = document.getElementById('details-id');
    const reportList = document.getElementById('report-list');
    const captureBtn = document.getElementById('capture-btn');
    const exportPdfBtn = document.getElementById('export-pdf-btn');

    const videoStream = document.getElementById('video-stream');
    const takePhotoButton = document.getElementById('take-photo-btn');
    const cameraBtn = document.getElementById('camera-btn');
    const closeCameraBtn = document.getElementById('close-camera-btn');
    const uploadBtn = document.getElementById('upload-btn');
    const processBtn = document.getElementById('process-btn');
    const photoCanvas = document.getElementById('photo-canvas');
    const processedCanvas = document.getElementById('processed-canvas');
    const photoDisplay = document.getElementById('photo-display');
    const loadingMessage = document.getElementById('loading-message');
    const cameraModal = document.getElementById('camera-modal');

    const modal = document.getElementById('info-modal');
    const modalContent = document.getElementById('info-modal-content');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const closeModalBtn = document.getElementById('close-modal-btn');

    let patients = [];
    let currentPatient = null;
    let currentImage = null;
    let stream = null;
    let analysisResult = null;
    let processedImage = null;

    // --- Service Worker para PWA (offline) ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            const serviceWorkerBlob = new Blob([`
                self.addEventListener('fetch', (event) => {
                    event.respondWith(fetch(event.request));
                });
            `], { type: 'application/javascript' });
            const serviceWorkerUrl = URL.createObjectURL(serviceWorkerBlob);
            navigator.serviceWorker.register(serviceWorkerUrl).then(registration => {
                console.log('Service Worker registrado con éxito:', registration);
            }).catch(error => {
                console.error('Fallo el registro del Service Worker:', error);
            });
        });
    }

    function showScreen(screen) {
        Object.values(screens).forEach(s => s.classList.add('hidden'));
        screen.classList.remove('hidden');
    }

    function showModal(title, body) {
        modalTitle.textContent = title;
        modalBody.innerHTML = body;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    closeModalBtn.onclick = () => {
        modal.classList.remove('flex');
        modal.classList.add('hidden');
    };

    window.onclick = (event) => {
        if (event.target === modal) {
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }
    };

    function loadPatients() {
        const storedPatients = localStorage.getItem('patients');
        if (storedPatients) {
            patients = JSON.parse(storedPatients);
        }
    }

    function savePatients() {
        localStorage.setItem('patients', JSON.stringify(patients));
    }

    function renderPatientList() {
        patientList.innerHTML = '';
        if (patients.length === 0) {
            patientList.innerHTML = '<p class="text-gray-500 text-center mt-4">No hay pacientes registrados.</p>';
        }
        patients.forEach(patient => {
            const patientElement = document.createElement('div');
            patientElement.className = 'p-4 border-b border-gray-200 cursor-pointer hover:bg-gray-100';
            patientElement.innerHTML = `
                <h3 class="font-bold text-gray-800">${patient.name}</h3>
                <p class="text-gray-600">ID: ${patient.id}</p>
            `;
            patientElement.onclick = () => {
                currentPatient = patient;
                renderPatientDetails();
                showScreen(screens.details);
            };
            patientList.appendChild(patientElement);
        });
    }

    function renderPatientDetails() {
        detailsName.textContent = currentPatient.name;
        detailsAge.textContent = currentPatient.age;
        detailsId.textContent = currentPatient.id;
        reportList.innerHTML = '';
        currentPatient.reports.forEach((report, index) => {
            const reportElement = document.createElement('div');
            reportElement.className = 'p-4 border-b border-gray-200';
            reportElement.innerHTML = `
                <p class="text-gray-600">Fecha: ${report.date}</p>
                <p class="text-gray-600">Resultados: ${report.results || 'No disponibles'}</p>
            `;
            reportList.appendChild(reportElement);
        });
    }

    newPatientBtn.onclick = () => {
        patientNameInput.value = '';
        patientAgeInput.value = '';
        patientIdInput.value = '';
        showScreen(screens.details);
    };

    backBtn.onclick = () => {
        showScreen(screens.list);
    };

    savePatientBtn.onclick = () => {
        const name = patientNameInput.value.trim();
        const age = patientAgeInput.value.trim();
        const id = patientIdInput.value.trim();
        if (name && age && id) {
            let patient = patients.find(p => p.id === id);
            if (patient) {
                patient.name = name;
                patient.age = age;
            } else {
                patient = { name, age, id, reports: [] };
                patients.push(patient);
            }
            currentPatient = patient;
            savePatients();
            renderPatientList();
            renderPatientDetails();
            showScreen(screens.details);
        } else {
            showModal('Error', 'Por favor, llena todos los campos.');
        }
    };

    captureBtn.onclick = () => {
        showScreen(screens.capture);
        processedCanvas.classList.add('hidden');
        processBtn.classList.add('hidden');
        photoDisplay.classList.add('hidden');
    };

    // --- Lógica de la cámara ---
    cameraBtn.addEventListener('click', async () => {
        try {
            // CAMBIO AQUÍ: `facingMode: 'environment'` para usar la cámara trasera
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' }, 
                audio: false 
            });
            videoStream.srcObject = stream;
            cameraModal.classList.remove('hidden');
            cameraModal.classList.add('flex');
        } catch (err) {
            console.error("Error al acceder a la cámara: ", err);
            showModal('Error de Cámara', 'No se pudo acceder a la cámara. Por favor, revisa los permisos.');
        }
    });

    closeCameraBtn.onclick = () => {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            videoStream.srcObject = null;
        }
        cameraModal.classList.remove('flex');
        cameraModal.classList.add('hidden');
    };

    takePhotoButton.onclick = () => {
        const context = photoCanvas.getContext('2d');
        const videoWidth = videoStream.videoWidth;
        const videoHeight = videoStream.videoHeight;
        photoCanvas.width = videoWidth;
        photoCanvas.height = videoHeight;
        context.drawImage(videoStream, 0, 0, videoWidth, videoHeight);
        const dataURL = photoCanvas.toDataURL('image/jpeg', 0.8);
        currentImage = dataURL;
        photoDisplay.src = dataURL;
        photoDisplay.classList.remove('hidden');
        processBtn.classList.remove('hidden');
        showModal('Foto Tomada', '¡Foto capturada con éxito!');
        closeCameraBtn.click();
    };

    uploadBtn.onclick = () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = async (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const context = photoCanvas.getContext('2d');
                        photoCanvas.width = img.width;
                        photoCanvas.height = img.height;
                        context.drawImage(img, 0, 0);
                        currentImage = photoCanvas.toDataURL('image/jpeg', 0.8);
                        photoDisplay.src = currentImage;
                        photoDisplay.classList.remove('hidden');
                        processBtn.classList.remove('hidden');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        };
        input.click();
    };

    processBtn.onclick = async () => {
        if (!currentImage) {
            showModal('Error', 'Por favor, captura o sube una imagen primero.');
            return;
        }

        loadingMessage.classList.remove('hidden');

        try {
            const base64Image = currentImage.split(',')[1];
            const response = await fetch('https://colpoai.onrender.com/analyze_colposcopy/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ image: base64Image }),
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            analysisResult = data.analysis;
            processedImage = data.processed_image;
            showModal('Análisis Completo', `Resultado: ${analysisResult}`);

            const img = new Image();
            img.onload = () => {
                const context = processedCanvas.getContext('2d');
                processedCanvas.width = img.width;
                processedCanvas.height = img.height;
                context.drawImage(img, 0, 0);
                processedCanvas.classList.remove('hidden');
                processedImage = processedCanvas.toDataURL('image/jpeg');
            };
            img.src = `data:image/jpeg;base64,${processedImage}`;

            currentPatient.reports.push({
                date: new Date().toLocaleDateString('es-ES'),
                image: currentImage,
                results: analysisResult,
                processed_image: processedImage
            });
            savePatients();
            renderPatientDetails();

        } catch (error) {
            console.error('Error durante el análisis:', error);
            showModal('Error de Análisis', 'Hubo un problema al procesar la imagen. Por favor, verifica el servidor.');
        } finally {
            loadingMessage.classList.add('hidden');
        }
    };

    exportPdfBtn.onclick = async () => {
        if (!currentPatient) {
            showModal('Error', 'Por favor, selecciona un paciente para exportar un informe.');
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(18);
        doc.setTextColor(50, 50, 50);
        doc.text("Informe ColpoVision", 14, 22);

        doc.setFontSize(12);
        doc.setTextColor(100, 100, 100);
        doc.text(`Paciente: ${currentPatient.name}`, 14, 32);
        doc.text(`ID: ${currentPatient.id}`, 14, 39);
        doc.text(`Edad: ${currentPatient.age}`, 14, 46);
        
        const latestReport = currentPatient.reports[currentPatient.reports.length - 1];

        if (latestReport) {
            doc.setFontSize(14);
            doc.setTextColor(50, 50, 50);
            doc.text("Último Análisis", 14, 60);
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text(`Fecha: ${latestReport.date}`, 14, 67);
            doc.text(`Resultados: ${latestReport.results}`, 14, 74);
            
            const imgData = latestReport.image;
            if (imgData) {
                const img = new Image();
                img.src = imgData;
                await new Promise(resolve => img.onload = resolve);
                const aspectRatio = img.width / img.height;
                const imgWidth = 80;
                const imgHeight = imgWidth / aspectRatio;
                doc.text("Imagen Original", 14, 88);
                doc.addImage(imgData, 'JPEG', 14, 95, imgWidth, imgHeight);

                if (latestReport.processed_image) {
                    const processedImg = new Image();
                    processedImg.src = latestReport.processed_image;
                    await new Promise(resolve => processedImg.onload = resolve);
                    doc.text("Imagen Procesada", 110, 88);
                    doc.addImage(latestReport.processed_image, 'JPEG', 110, 95, imgWidth, imgHeight);
                }
            }
        } else {
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text("No hay informes para este paciente.", 14, 60);
        }

        // Firma
        const signatureText = 'Dr. [Nombre del Doctor]';
        const signatureImgUrl = 'https://i.ibb.co/68v8z3F/Firma-Prueba.png'; 
        const signatureImgWidth = 60;
        const footerY = doc.internal.pageSize.height - 30;
        const signatureAreaX = (doc.internal.pageSize.width - signatureImgWidth) / 2;
        
        if (signatureImgUrl) {
            try {
                const img = await fetch(signatureImgUrl).then(res => res.blob()).then(blob => new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                }));
                doc.addImage(img, 'PNG', signatureAreaX, footerY, signatureImgWidth, 20);
                doc.setFontSize(10);
                doc.setTextColor(80, 80, 80);
                doc.text(signatureText, signatureAreaX + (signatureImgWidth / 2), footerY + 25, { align: 'center' });
            } catch (error) {
                console.error("Error al cargar la imagen de firma para PDF:", error);
                doc.setFontSize(10);
                doc.setTextColor(80, 80, 80);
                doc.text('_________________________________', signatureAreaX + (signatureImgWidth / 2), footerY + 5, { align: 'center' });
                doc.text(signatureText, signatureAreaX + (signatureImgWidth / 2), footerY + 10, { align: 'center' });
            }
        } else {
            doc.setFontSize(10);
            doc.setTextColor(80, 80, 80);
            doc.text('_________________________________', signatureAreaX + (signatureImgWidth / 2), footerY + 5, { align: 'center' });
            doc.text(signatureText, signatureAreaX + (signatureImgWidth / 2), footerY + 10, { align: 'center' });
        }
    
        doc.save(`Informe_ColpoVision_${currentPatient.name}.pdf`);
        showModal('PDF Exportado', 'El informe se ha exportado a PDF correctamente.');
    };
    
    applySavedTheme();
    loadPatients();
    renderPatientList();
    showScreen(screens.list);

    function applySavedTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.classList.add(savedTheme);
        document.getElementById('theme-toggle').checked = (savedTheme === 'dark');
    }

    document.getElementById('theme-toggle').addEventListener('change', (e) => {
        if (e.target.checked) {
            document.documentElement.classList.add('dark');
            localStorage.setItem('theme', 'dark');
        } else {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('theme', 'light');
        }
    });

</script>
</body>
</html>