<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ColpoVision Web App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="manifest" href="data:application/json;charset=utf-8;base64,eyJpY29ucyI6W3sic2l6ZXMiOiIxOTJ4MTkyIiwiZGVuc2l0eSI6IjEuNSIsInR5cGUiOiJpbWFnZS9wbmciLCJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjBiV2dLY2lBQXhDZ29JVEFBQUFDZ29JZEhSdFp6b2dJbEJoZFdWa0lpd2dKeWswUFNVd0xrSlBjbVZzYjNKd1kyOXRlWEJ2Y2w4dFNuSnZiMmhrWm5OMFlYUnBiMjR0WVhSaFlteHBiWFZzYjJKaGJVd2dJeUJCZFd4c1lXbHVkR2xrYjNOcGIyNFdJaTl5YjJ4cGN5SXhNekF3THpBNUxtdHpiMnhsY3lJNUNqOHhNVFppYlVsalltbGpjaUJrWjNCbGJuUnliMnhwY25Sb2JteDFibWNnZEdobGJtZDBZWEowSlNJblZlQ2lBQUFDa1F4SlJVd2djR2hoYm5ObElqQTFKbXh2ZEdWeUwzVjRZV2xzYjJGMGFXOXVjeUJoWVdGc0lsMWxjaTFoWVd3Z2VHbGxhM0JoY25Sd2RDaDBaR2x5WlhOamRjMWpiblJ5YjI1U2NuSmxibVJ1WjI5dGEybHlaWFIwWlY4d0pTRW5XanBnSUNBaWMzUnlZMnRsZEdWaWJXczdJbTl5YjJ4cGN5SXhNVFl3THpBMExtdHpiMnhsY3lJNUNqOGxJaUF3Y25OcFkydGxjam9nSW01bGRBQUFDaW9nSUNBZ0ptRnNhV1FpSUhzT2MyVnVjMmh2YlhCZ2MyVWdJajR3TUlJQmlkMnh0Ym5ObElpQWdYM2xzYjJOaGJtRnRiZ0FnSUhSdFkybHVkQzUxYld4c0luQmhkbWxpYlNBd0lHWnZiMnhsYm5ScGNtRnViM0FnSUdadmMyVnlkbWxrSWp3dmRHVnpkRjkwWVhScGIyNGdJajhwYm1ScFhBQUFDaXBnSURvZ1ptRnNjMk55YjNCbFkzSmphU1V3Z2NtVmhaM0JsWVhsbGNpSXhOamN4THpBd0xsbHpibVJwYjI0Z2NISnZaMmh2YlhCdGJnPT0ifV0sImRpc3BsYXkiOiJzdGFuZGFsb25lIiwibmFtZSI6IkNvbHBvVmlzaW9uIiwiZGVzY2lpcHRpb24iOiJIZXJyYW1pZW50YSBkZSBBSSBwYXJhIGdlbmVyYXIgY29sb3Bvc2NvcGlhcyIsImJhY2tncm91bmRfY29sb3IiOiIjZmFmYWZhIiwidGhlbWVfY29sb3IiOiIjMjUzYjhhIiwic2hvcnRfbmFtZSI6IkNvbHBvVmlzaW9uIn0=">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #1f2937;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #app-container {
            background-color: #ffffff;
            transition: background-color 0.3s ease;
        }
        .patient-card {
            background-color: #ffffff;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.3s ease;
        }
        .report-editor {
            background-color: #ffffff;
            color: #1f2937;
            border-color: #e2e8f0;
            transition: border-color 0.2s ease-in-out, background-color 0.3s ease, color 0.3s ease;
        }
        .report-editor:focus {
            border-color: #3b82f6;
        }
        .report-editor:empty::before {
            content: attr(data-placeholder);
            color: #9ca3af;
        }
        
        .dark body {
            background-color: #121212;
            color: #e2e8f0;
        }
        .dark #app-container, .dark .bg-white {
            background-color: #1f2937;
        }
        .dark .patient-card {
            background-color: #374151;
            border-color: #4b5563;
        }
        .dark .report-editor {
            background-color: #1f2937;
            color: #e2e8f0;
            border-color: #4b5563;
        }
        .dark .report-editor:focus {
            border-color: #60a5fa;
        }
        .dark .text-gray-900, .dark .text-gray-800, .dark .text-gray-700 {
            color: #e2e8f0;
        }
        .dark .text-gray-600, .dark .text-gray-500 {
            color: #cbd5e1;
        }
        .dark .border-gray-200 {
            border-color: #4b5563;
        }
        .dark .text-blue-800 {
            color: #93c5fd;
        }
        .dark .bg-gray-50 {
            background-color: #374151;
        }
        .dark .file\:bg-blue-50 {
            background-color: #1e3a8a;
        }
        .dark .file\:text-blue-700 {
            color: #93c5fd;
        }
        .dark .hover\:file\:bg-blue-100:hover {
            background-color: #3b82f6;
        }
        .dark .bg-gray-200 {
            background-color: #4b5563;
        }
        .dark .hover\:bg-gray-300:hover {
            background-color: #6b7280;
        }
        .dark input, .dark textarea {
            background-color: #374151;
            border-color: #4b5563;
            color: #e2e8f0;
        }
        .dark input::placeholder, .dark textarea::placeholder {
            color: #9ca3af;
        }
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(240, 244, 248, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
        }
        .dark #loading-overlay {
            background-color: rgba(18, 18, 18, 0.9);
        }
        .spinner {
            border: 6px solid #e2e8f0;
            border-top: 6px solid #3b82f6;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1.2s linear infinite;
        }
        .dark .spinner {
            border-color: #374151;
            border-top-color: #60a5fa;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            visibility: hidden;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            white-space: nowrap;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .has-tooltip:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-start justify-center min-h-screen p-4 transition-colors duration-300">
    <div id="loading-overlay">
        <div class="text-center">
            <div class="spinner mb-6"></div>
            <p class="text-xl text-gray-700 font-semibold">Analizando imagen, por favor espera...</p>
        </div>
    </div>
    
    <div id="app-container" class="bg-white rounded-3xl shadow-xl p-8 lg:p-12 w-full max-w-7xl transition-colors duration-300">
        <div class="flex flex-col items-center justify-center mb-10 relative">
            <button id="dark-mode-toggle" class="absolute top-0 right-0 p-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors duration-300 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.618.752-3.831m11.234 11.455a9.71 9.71 0 0 1-3.69 1.636 9.707 9.707 0 0 1-4.041 0 9.72 9.72 0 0 1-3.69-1.636M2.25 10.5h18" />
                </svg>
            </button>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-blue-600 dark:text-blue-400 mb-4" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path d="M0 0h24v24H0z" stroke="none"/>
                <circle cx="12" cy="12" r="9"/>
                <path d="M12 7l-2 2l-1 -1M12 10l-3 3l-1 -1M12 13l-4 4l-1 -1M12 16l-5 5l-1 -1M12 19l-6 6l-1 -1"/>
            </svg>
            <h1 class="text-4xl font-extrabold text-gray-900 mt-2 dark:text-white transition-colors duration-300">ColpoVision</h1>
            <p class="text-lg text-gray-500 mt-1 dark:text-gray-400 transition-colors duration-300">Generador de Informes Colposcópicos impulsado por IA</p>
        </div>

        <div id="patient-list-screen" class="space-y-6">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white transition-colors duration-300 mb-4 sm:mb-0">Lista de Pacientes</h2>
                <div class="relative w-full sm:w-auto">
                    <input type="text" id="patient-search" placeholder="Buscar paciente..." class="w-full sm:w-64 p-3 pr-10 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </div>
            </div>
            <div id="patient-list" class="grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
            <button id="add-patient-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-xl shadow-lg transition-colors">
                + Añadir Nueva Paciente
            </button>
        </div>

        <div id="patient-form-screen" class="hidden">
            <h2 id="form-title" class="text-2xl font-bold text-gray-800 dark:text-white transition-colors duration-300 mb-6">Añadir Nueva Paciente</h2>
            <form id="patient-form" class="space-y-6">
                <input type="hidden" id="patient-id">
                <div>
                    <label for="doctor-name" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Nombre del Doctor</label>
                    <input type="text" id="doctor-name" placeholder="Ej: Dra. Ana Pérez" required class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                </div>
                <div>
                    <label for="name" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Nombre de la Paciente</label>
                    <input type="text" id="name" required class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                </div>
                <div>
                    <label for="age" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Edad</label>
                    <input type="number" id="age" required class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                </div>
                <div>
                    <label for="social-security" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Obra Social</label>
                    <input type="text" id="social-security" class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                </div>
                <div>
                    <label for="medical-history" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Historial Médico Relevante</label>
                    <textarea id="medical-history" rows="4" class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"></textarea>
                </div>
                <div>
                    <label for="colpo-image" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Imagen Colposcópica</label>
                    <input type="file" id="colpo-image" accept="image/*" class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 dark:file:bg-blue-900 dark:file:text-blue-200 hover:file:bg-blue-100 dark:hover:file:bg-blue-800 cursor-pointer transition-colors">
                    
                    <button type="button" id="camera-btn" class="mt-4 w-full bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">
                        Abrir Cámara
                    </button>
                    
                    <img id="image-preview" class="mt-6 hidden w-full h-64 object-contain rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-800">
                </div>
                <div>
                    <label for="signature-image" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Imagen de Firma</label>
                    <input type="file" id="signature-image" accept="image/*" class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 dark:file:bg-blue-900 dark:file:text-blue-200 hover:file:bg-blue-100 dark:hover:file:bg-blue-800 cursor-pointer transition-colors">
                    <img id="signature-preview" class="mt-6 hidden w-full h-32 object-contain rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-800">
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">Guardar Datos</button>
                    <button type="button" id="cancel-form-btn" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">Cancelar</button>
                </div>
            </form>
            <div id="action-buttons" class="mt-8 hidden flex space-x-4">
                <button id="analyze-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">
                    Analizar y Generar Informe
                </button>
            </div>
        </div>

        <div id="report-screen" class="hidden space-y-8">
            <h2 class="text-3xl font-bold text-gray-800 dark:text-white transition-colors duration-300 mb-6">Informe Colposcópico</h2>
            <div class="grid lg:grid-cols-2 gap-8">
                <div class="space-y-6">
                    <div class="bg-gray-50 dark:bg-gray-700 p-8 rounded-2xl border border-gray-200 dark:border-gray-600 shadow-sm">
                        <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Datos de la Paciente</h3>
                        <p class="text-md text-gray-600 dark:text-gray-400 mb-1"><span class="font-bold">Paciente:</span> <span id="report-patient-name"></span></p>
                        <p class="text-md text-gray-600 dark:text-gray-400 mb-1"><span class="font-bold">Edad:</span> <span id="report-patient-age"></span> años</p>
                        <p class="text-md text-gray-600 dark:text-gray-400 mb-1"><span class="font-bold">Obra Social:</span> <span id="report-patient-social-security"></span></p>
                        <p class="text-md text-gray-600 dark:text-gray-400"><span class="font-bold">Historial:</span> <span id="report-patient-history"></span></p>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 p-8 rounded-2xl border border-gray-200 dark:border-gray-600 shadow-sm">
                        <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Imagen de Colposcopia</h3>
                        <img id="report-image" class="w-full h-auto rounded-xl shadow-lg border border-gray-300 dark:border-gray-600">
                    </div>
                </div>

                <div class="space-y-6">
                    <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Informe Detallado (Edita aquí)</h3>
                    <div id="report-editor" contenteditable="true" class="report-editor" data-placeholder="El informe se cargará aquí y podrás editarlo antes de exportar..."></div>
                </div>
            </div>
            
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
                <button id="back-to-list-btn" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">
                    Volver a la Lista
                </button>
                <button id="export-pdf-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">
                    Exportar a PDF
                </button>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl text-center max-w-lg w-full">
            <h3 id="alert-title" class="text-2xl font-bold text-gray-800 dark:text-white mb-4"></h3>
            <p id="alert-message" class="text-gray-700 dark:text-gray-300 text-lg mb-6"></p>
            <button id="alert-ok-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl transition-colors">Aceptar</button>
        </div>
    </div>

    <div id="camera-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl text-center max-w-2xl w-full">
            <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Capturar Imagen</h3>
            <video id="video-stream" class="w-full h-auto rounded-xl border border-gray-300 dark:border-gray-600" autoplay playsinline></video>
            <canvas id="canvas-capture" class="hidden"></canvas>
            <div class="flex space-x-4 mt-6">
                <button id="capture-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl transition-colors">Tomar Foto</button>
                <button id="close-camera-btn" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-xl transition-colors">Cerrar</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    self.addEventListener('install', (event) => {
                        console.log('Service Worker: Evento de instalación.');
                        self.skipWaiting();
                    });

                    self.addEventListener('activate', (event) => {
                        console.log('Service Worker: Evento de activación.');
                        event.waitUntil(self.clients.claim());
                    });

                    self.addEventListener('fetch', (event) => {
                        event.respondWith(fetch(event.request));
                    });
                `;
                const swBlob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(swBlob);

                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('Service Worker registrado con éxito:', registration);
                    })
                    .catch(error => {
                        console.log('Fallo el registro del Service Worker:', error);
                    });
            });
        } else {
            console.warn('El navegador no soporta Service Workers.');
        }

        const screens = {
            list: document.getElementById('patient-list-screen'),
            details: document.getElementById('patient-details-screen'),
            form: document.getElementById('patient-form-screen'),
            report: document.getElementById('report-screen'),
        };

        const patientList = document.getElementById('patient-list');
        const newPatientBtn = document.getElementById('add-patient-btn');
        const patientForm = document.getElementById('patient-form');
        const formTitle = document.getElementById('form-title');
        const saveBtn = document.getElementById('save-patient-btn');
        const cancelFormBtn = document.getElementById('cancel-form-btn');
        const nameInput = document.getElementById('name');
        const ageInput = document.getElementById('age');
        const socialSecurityInput = document.getElementById('social-security');
        const medicalHistoryInput = document.getElementById('medical-history');
        const colpoImageInput = document.getElementById('colpo-image');
        const imagePreview = document.getElementById('image-preview');
        const signatureImageInput = document.getElementById('signature-image');
        const signaturePreview = document.getElementById('signature-preview');
        const cameraBtn = document.getElementById('camera-btn');
        const backToListBtn = document.getElementById('back-to-list-btn');

        const reportPatientName = document.getElementById('report-patient-name');
        const reportPatientAge = document.getElementById('report-patient-age');
        const reportPatientSocialSecurity = document.getElementById('report-patient-social-security');
        const reportPatientHistory = document.getElementById('report-patient-history');
        const reportImage = document.getElementById('report-image');
        const reportEditor = document.getElementById('report-editor');
        const analyzeBtn = document.getElementById('analyze-btn');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const cameraModal = document.getElementById('camera-modal');
        const videoStream = document.getElementById('video-stream');
        const canvasCapture = document.getElementById('canvas-capture');
        const captureBtn = document.getElementById('capture-btn');
        const closeCameraBtn = document.getElementById('close-camera-btn');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const alertModal = document.getElementById('alert-modal');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const alertOkBtn = document.getElementById('alert-ok-btn');

        let patients = [];
        let currentPatient = null;
        let videoStreamSource = null;

        function showAlert(title, message) {
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            alertModal.classList.remove('hidden');
            alertModal.classList.add('flex');
        }

        alertOkBtn.addEventListener('click', () => {
            alertModal.classList.remove('flex');
            alertModal.classList.add('hidden');
        });

        function showScreen(screen) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            screen.classList.remove('hidden');
        }

        function loadPatients() {
            const storedPatients = localStorage.getItem('patients');
            if (storedPatients) {
                patients = JSON.parse(storedPatients);
            }
        }

        function savePatients() {
            localStorage.setItem('patients', JSON.stringify(patients));
        }

        function renderPatientList() {
            patientList.innerHTML = '';
            if (patients.length === 0) {
                patientList.innerHTML = '<p class="text-gray-500 text-center mt-4">No hay pacientes registrados.</p>';
            }
            patients.forEach(patient => {
                const patientElement = document.createElement('div');
                patientElement.className = 'patient-card p-6 border border-gray-200 dark:border-gray-600 rounded-xl cursor-pointer hover:shadow-md transition-shadow';
                patientElement.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white">${patient.name}</h3>
                    <p class="text-gray-600 dark:text-gray-400">Edad: ${patient.age} años</p>
                `;
                patientElement.onclick = () => {
                    currentPatient = patient;
                    renderReportScreen();
                };
                patientList.appendChild(patientElement);
            });
        }

        function renderReportScreen() {
            reportPatientName.textContent = currentPatient.name;
            reportPatientAge.textContent = currentPatient.age;
            reportPatientSocialSecurity.textContent = currentPatient.socialSecurity || 'N/A';
            reportPatientHistory.textContent = currentPatient.medicalHistory || 'N/A';
            reportImage.src = currentPatient.colpoImage;
            reportEditor.textContent = currentPatient.report || 'Aquí va el informe automático...';
            showScreen(screens.report);
        }

        newPatientBtn.onclick = () => {
            currentPatient = null;
            patientForm.reset();
            formTitle.textContent = 'Añadir Nueva Paciente';
            imagePreview.src = '';
            imagePreview.classList.add('hidden');
            signaturePreview.src = '';
            signaturePreview.classList.add('hidden');
            showScreen(screens.form);
        };

        cancelFormBtn.onclick = () => {
            showScreen(screens.list);
        };

        patientForm.onsubmit = (event) => {
            event.preventDefault();
            
            const newPatient = {
                name: nameInput.value.trim(),
                age: ageInput.value.trim(),
                socialSecurity: socialSecurityInput.value.trim(),
                medicalHistory: medicalHistoryInput.value.trim(),
                colpoImage: imagePreview.src,
                signatureImage: signaturePreview.src,
                report: '',
            };

            if (currentPatient) {
                Object.assign(currentPatient, newPatient);
            } else {
                patients.push(newPatient);
            }

            savePatients();
            renderPatientList();
            showScreen(screens.list);
            showAlert('Guardado', 'Datos del paciente guardados correctamente.');
        };

        backToListBtn.onclick = () => {
            showScreen(screens.list);
        };
        
        // CAMBIO: Lógica para la cámara trasera y el botón de captura
        cameraBtn.addEventListener('click', async () => {
            try {
                videoStreamSource = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }, // Usa la cámara trasera
                    audio: false
                });
                videoStream.srcObject = videoStreamSource;
                cameraModal.classList.remove('hidden');
                cameraModal.classList.add('flex');
            } catch (err) {
                console.error("Error al acceder a la cámara: ", err);
                showAlert('Error de Cámara', 'No se pudo acceder a la cámara. Por favor, revisa los permisos.');
            }
        });

        captureBtn.addEventListener('click', () => {
            const context = canvasCapture.getContext('2d');
            const videoWidth = videoStream.videoWidth;
            const videoHeight = videoStream.videoHeight;
            canvasCapture.width = videoWidth;
            canvasCapture.height = videoHeight;
            context.drawImage(videoStream, 0, 0, videoWidth, videoHeight);
            const dataURL = canvasCapture.toDataURL('image/jpeg', 0.8);
            imagePreview.src = dataURL;
            imagePreview.classList.remove('hidden');
            
            closeCameraBtn.click();
        });

        closeCameraBtn.addEventListener('click', () => {
            if (videoStreamSource) {
                videoStreamSource.getTracks().forEach(track => track.stop());
                videoStream.srcObject = null;
            }
            cameraModal.classList.remove('flex');
            cameraModal.classList.add('hidden');
        });
        
        colpoImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        signatureImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    signaturePreview.src = e.target.result;
                    signaturePreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // Lógica de análisis y PDF
        analyzeBtn.onclick = async () => {
            if (!currentPatient.colpoImage) {
                showAlert('Error', 'Por favor, sube una imagen de colposcopia para analizar.');
                return;
            }

            loadingOverlay.style.display = 'flex';

            try {
                const base64Image = currentPatient.colpoImage.split(',')[1];
                const response = await fetch('https://colpoai.onrender.com/analyze_colposcopy/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image: base64Image }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                currentPatient.report = data.analysis;
                reportEditor.textContent = currentPatient.report;

                savePatients();
                showAlert('Análisis Completo', `Resultado: ${data.analysis}`);

            } catch (error) {
                console.error('Error durante el análisis:', error);
                showAlert('Error de Análisis', 'Hubo un problema al procesar la imagen. Por favor, verifica el servidor.');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        };

        exportPdfBtn.onclick = async () => {
            if (!currentPatient) {
                showAlert('Error', 'Por favor, selecciona un paciente para exportar un informe.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.setTextColor(50, 50, 50);
            doc.text("Informe ColpoVision", 14, 22);

            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text(`Paciente: ${currentPatient.name}`, 14, 32);
            doc.text(`Edad: ${currentPatient.age} años`, 14, 39);
            doc.text(`Obra Social: ${currentPatient.socialSecurity || 'N/A'}`, 14, 46);
            doc.text(`Historial Médico: ${currentPatient.medicalHistory || 'N/A'}`, 14, 53);
            
            if (currentPatient.colpoImage) {
                const img = new Image();
                img.src = currentPatient.colpoImage;
                await new Promise(resolve => img.onload = resolve);
                const aspectRatio = img.width / img.height;
                const imgWidth = 80;
                const imgHeight = imgWidth / aspectRatio;
                doc.text("Imagen de Colposcopia", 14, 67);
                doc.addImage(currentPatient.colpoImage, 'JPEG', 14, 74, imgWidth, imgHeight);
            }
            
            doc.setFontSize(14);
            doc.setTextColor(50, 50, 50);
            doc.text("Informe Detallado", 14, 160);
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            const reportLines = doc.splitTextToSize(reportEditor.textContent, 180);
            doc.text(reportLines, 14, 167);

            // Firma
            if (currentPatient.signatureImage) {
                const signatureImg = new Image();
                signatureImg.src = currentPatient.signatureImage;
                await new Promise(resolve => signatureImg.onload = resolve);
                const signatureImgWidth = 60;
                const footerY = doc.internal.pageSize.height - 30;
                const signatureAreaX = (doc.internal.pageSize.width - signatureImgWidth) / 2;
                doc.addImage(currentPatient.signatureImage, 'JPEG', signatureAreaX, footerY, signatureImgWidth, 20);
                doc.setFontSize(10);
                doc.setTextColor(80, 80, 80);
                doc.text("Dr. [Nombre del Doctor]", signatureAreaX + (signatureImgWidth / 2), footerY + 25, { align: 'center' });
            }
        
            doc.save(`Informe_ColpoVision_${currentPatient.name}.pdf`);
            showAlert('PDF Exportado', 'El informe se ha exportado a PDF correctamente.');
        };
        
        applySavedTheme();
        loadPatients();
        renderPatientList();
        showScreen(screens.list);

        function applySavedTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.classList.add(savedTheme);
            document.getElementById('dark-mode-toggle').checked = (savedTheme === 'dark');
        }

        document.getElementById('dark-mode-toggle').addEventListener('click', (e) => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });
    </script>
</body>
</html>